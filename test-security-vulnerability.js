// Security Vulnerability Test
// This script demonstrates the cross-creator action vulnerability
// Run with: node test-security-vulnerability.js

import { ConvexHttpClient } from "convex/browser";

const CONVEX_URL = process.env.NEXT_PUBLIC_CONVEX_URL || "https://tremendous-goose-573.convex.cloud";
const client = new ConvexHttpClient(CONVEX_URL);

async function testCrossCreatorApproval() {
  console.log("üîç Testing Cross-Creator Approval Vulnerability\n");

  // Replace with actual ticket refs from different creators
  const otherCreatorTicketRef = "SPARK-PPP-9464"; // User B's ticket

  try {
    console.log("Attempting to approve another creator's ticket...");
    console.log(`Ticket Ref: ${otherCreatorTicketRef}\n`);

    // This should FAIL but currently SUCCEEDS ‚ùå
    const result = await client.mutation(
      { _name: "tickets.js:approve" }, 
      { ref: otherCreatorTicketRef }
    );

    if (result.ok) {
      console.log("‚ùå VULNERABILITY CONFIRMED!");
      console.log("‚úó Successfully approved another creator's ticket WITHOUT authentication!");
      console.log("‚úó This is a critical security flaw.\n");
    }
  } catch (error) {
    console.log("‚úÖ SECURITY WORKING!");
    console.log("‚úì Failed to approve another creator's ticket (as expected)");
    console.log(`‚úì Error: ${error.message}\n`);
  }
}

async function testCrossCreatorRejection() {
  console.log("üîç Testing Cross-Creator Rejection Vulnerability\n");

  const otherCreatorTicketRef = "SPARK-PPP-9464";

  try {
    console.log("Attempting to reject another creator's ticket...");
    console.log(`Ticket Ref: ${otherCreatorTicketRef}\n`);

    const result = await client.mutation(
      { _name: "tickets.js:reject" },
      { ref: otherCreatorTicketRef }
    );

    if (result.ok) {
      console.log("‚ùå VULNERABILITY CONFIRMED!");
      console.log("‚úó Successfully rejected another creator's ticket WITHOUT authentication!");
      console.log("‚úó This is a critical security flaw.\n");
    }
  } catch (error) {
    console.log("‚úÖ SECURITY WORKING!");
    console.log("‚úì Failed to reject another creator's ticket (as expected)");
    console.log(`‚úì Error: ${error.message}\n`);
  }
}

async function runTests() {
  console.log("=" .repeat(60));
  console.log("Security Vulnerability Test Suite");
  console.log("=" .repeat(60) + "\n");

  await testCrossCreatorApproval();
  await testCrossCreatorRejection();

  console.log("=" .repeat(60));
  console.log("Test Complete");
  console.log("=" .repeat(60));
}

runTests().catch(console.error);
